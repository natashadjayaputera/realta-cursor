---
alwaysApply: false
priority: HIGH
glob: "*ToCSharpService*"
---

# SERVICE LAYER RULES

## Project Structure
- Location: `SERVICE/{module}/{ProgramName}Service/`
- Target: `net6.0`
- Purpose: Controllers, API endpoints

## Streaming Context Rules
- **Global Variable**: Use `R_BackGlobalVar.COMPANY_ID`, `R_BackGlobalVar.USER_ID`
- **Custom Parameters**: Use `R_Utility.R_GetStreamingContext<string>(ContextConstants.KEY)`
- **NO Parameters**: IAsyncEnumerable methods have NO parameters in interface/controller

## Controller Requirements
- Inherit `ControllerBase, I{ProgramName}`
- All methods decorated with `[HttpPost]`
- Route pattern: `[Route("api/[controller]/[action]")]`
- Logger and Activity initialized in constructor

## Access Level Patterns
- **Controllers call public methods** from `R_BusinessObjectAsync` base class:
  - `R_GetRecordAsync()` (not `R_DisplayAsync`)
  - `R_SaveAsync()` (not `R_SavingAsync`)
  - `R_DeleteAsync()` (not `R_DeletingAsync`)
- **Protected override methods** (`R_DisplayAsync`, `R_SavingAsync`, `R_DeletingAsync`) are internal to the business logic class

## Parameter Passing Optimization
- **When controller and business logic use the same DTO type, pass directly** - no need to create new instances
- **Streaming methods are special** - they use `R_Utility.R_GetStreamingContext()` to get parameters, not method parameters
- **Non-streaming methods use specific parameter DTOs** in both interface and implementation

## Violations
- ❌ IAsyncEnumerable methods with parameters
- ❌ Setting Global Variable in streaming context
- ❌ Missing R_BackGlobalVar usage for IClientHelper data
- ❌ Set `R_BackGlobalVar` manually
- ❌ Put business logic in controllers
- ❌ Wrong route patterns
- ❌ Calling protected methods (`R_DisplayAsync`, `R_SavingAsync`) from controllers
- ❌ Creating unnecessary parameter DTOs when types match