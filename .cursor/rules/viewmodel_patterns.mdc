---
alwaysApply: false
priority: HIGH
glob: "*ToCSharpViewModel*"
---

# VIEWMODEL LAYER PATTERNS

## DLL References
```xml
<Reference Include="R_APIClient">
  <HintPath>..\..\..\..\SYSTEM\SOURCE\LIBRARY\Front\R_APIClient.dll</HintPath>
</Reference>
<Reference Include="R_BusinessObjectFront">
  <HintPath>..\..\..\..\SYSTEM\SOURCE\LIBRARY\Front\R_BusinessObjectFront.dll</HintPath>
</Reference>
<Reference Include="R_BlazorFrontEnd">
  <HintPath>..\..\..\..\SYSTEM\SOURCE\LIBRARY\Front\R_BlazorFrontEnd.dll</HintPath>
</Reference>
```

## Required Using Statements
```csharp
using R_BlazorFrontEnd.Exceptions;
using R_BlazorFrontEnd.Interfaces;
using R_BlazorFrontEnd;  // Required for R_ViewModel<T>
using R_CommonFrontBackAPI;
```

## ViewModel Inheritance Pattern - CRITICAL
```csharp
// ✅ CORRECT - All ViewModels MUST inherit from R_ViewModel<T>
public class FAM00100ViewModel : R_ViewModel<FAM00100DTO>
{
    private readonly FAM00100Model _model = new FAM00100Model();
    // Data property is inherited from R_ViewModel<T> - DO NOT declare manually
    // Other properties and methods...
}
```

## CRUD Operations Pattern - MANDATORY
```csharp
// ✅ CORRECT - CRUD methods for ViewModels with grids/conductors
public async Task GetRecordAsync(FAM00100DTO poEntity)
{
    var loEx = new R_Exception();
    try
    {
        var loResult = await _model.R_ServiceGetRecordAsync(poEntity);
        CurrentRecord = loResult; // Store in separate property, NOT Data
    }
    catch (Exception ex) { loEx.Add(ex); }
    loEx.ThrowExceptionIfErrors();
}

public async Task SaveRecordAsync(FAM00100DTO poEntity, eCRUDMode peCRUDMode)
{
    var loEx = new R_Exception();
    try
    {
        var loResult = await _model.R_ServiceSaveAsync(poEntity, peCRUDMode);
        CurrentRecord = loResult; // Store in separate property, NOT Data
    }
    catch (Exception ex) { loEx.Add(ex); }
    loEx.ThrowExceptionIfErrors();
}

public async Task DeleteRecordAsync(FAM00100DTO poEntity)
{
    var loEx = new R_Exception();
    try
    {
        await _model.R_ServiceDeleteAsync(poEntity);
    }
    catch (Exception ex) { loEx.Add(ex); }
    loEx.ThrowExceptionIfErrors();
}
```

## Data Property Usage - CRITICAL
```csharp
// ✅ CORRECT - Data property is READ-ONLY, use separate properties
public class FAM00100ViewModel : R_ViewModel<FAM00100DTO>
{
    // Data property is inherited and READ-ONLY - DO NOT assign to it
    public FAM00100DTO CurrentRecord { get; set; } = new FAM00100DTO(); // ✅ Use this instead
}

// ❌ WRONG - Cannot assign to Data property
Data = loResult; // CS0200: Property cannot be assigned to
```

## Grid Data Binding Pattern
**CRITICAL:** Grid data must flow through ViewModel properties, not return values

### Correct Data Flow
1. **Grid requests data** → `R_ServiceGetListRecord` is called
2. **ViewModel populates property** → `GetListAsync()` fills `DataList` property
3. **Grid receives data** → `eventArgs.ListEntityResult = _viewModel.DataList`

```csharp
// ✅ CORRECT - Populate ViewModel property
public async Task GetListAsync(FilterRequest poRequest)
{
    var loResult = await _model.GetListAsync(poRequest);
    if (loResult.Data != null)
    {
        DataList.Clear();
        DataList = new ObservableCollection<DTO>(loResult.Data);
    }
}

// ❌ WRONG - Returning data
public async Task<ObservableCollection<DTO>> GetListAsync(FilterRequest poRequest)
{
    var loResult = await _model.GetListAsync(poRequest);
    return new ObservableCollection<DTO>(loResult.Data);
}
```

### Grid Service Method
```csharp
public async Task R_ServiceGetListRecord(R_ServiceGetListRecordEventArgs eventArgs)
{
    var loRequest = new FilterRequest { /* parameters */ };
    await _viewModel.GetListAsync(loRequest); // Populates ViewModel property
    eventArgs.ListEntityResult = _viewModel.DataList; // Assign to grid
}
```

### Violations
- ❌ Returning collections instead of populating properties


## Frontend Global Variable Pattern (CRITICAL)
**RULE**: Never use `R_FrontGlobalVar` in ViewModels. Use `IClientHelper` injection in .razor.cs and pass values as parameters.

### ❌ Wrong Pattern - Using R_FrontGlobalVar in ViewModel
```csharp
// WRONG - Don't use R_FrontGlobalVar in ViewModel
public async Task GetRateTypeListAsync()
{
    var request = new SAM00110GetListRequest
    {
        CCOMPANY_ID = R_FrontGlobalVar.COMPANY_ID  // ❌ This class doesn't exist in .NET 6
    };
    // ...
}
```

## Viewmodel Pattern for Streaming Method
```csharp
public ObservableCollection<GetStreamingListResultDTO> StreamingList = new ObservableCollection<GetStreamingListResultDTO>();

public async Task GetStreamingListAsync(GetStreamingListParameterDTO poParameter)
{
    var loEx = new R_Exception();

    try
    {
        // Set streaming context for non-IClientHelper parameters
        R_FrontContext.R_SetStreamingContext("OTHER_PARAM_KEY", poParameter.OTHER_PARAM_KEY);

        var loResult = await _model.GetStreamingListAsync();

        StreamingList = new ObservableCollection<GetStreamingListResultDTO>(loResult.Data ?? new List<GetStreamingListResultDTO>());
    }
    catch (Exception ex)
    {
        loEx.Add(ex);
    }

    loEx.ThrowExceptionIfErrors();
}
```

## Error Message from Resources
**CRITICAL:** All error messages MUST come from resource files, never hardcoded

```csharp
var lcErrorMessage = R_FrontUtility.R_GetError(typeof(Resources_Dummy_Class), "ERR_INVALID_COMPANY_ID");
throw new R_Exception(lcErrorMessage);
```