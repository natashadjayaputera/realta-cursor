---
alwaysApply: false
priority: HIGH
glob: "*ToCSharpViewModel*"
---

# VIEWMODEL LAYER PATTERNS

## DLL References - Complete List
```xml
<Reference Include="R_APIClient">
  <HintPath>..\..\..\..\SYSTEM\SOURCE\LIBRARY\Front\R_APIClient.dll</HintPath>
</Reference>
<Reference Include="R_APICommonDTO">
  <HintPath>..\..\..\..\SYSTEM\SOURCE\LIBRARY\Front\R_APICommonDTO.dll</HintPath>
</Reference>
<Reference Include="R_BusinessObjectFront">
  <HintPath>..\..\..\..\SYSTEM\SOURCE\LIBRARY\Front\R_BusinessObjectFront.dll</HintPath>
</Reference>
<Reference Include="R_CommonFrontBackAPI">
  <HintPath>..\..\..\..\SYSTEM\SOURCE\LIBRARY\Front\R_CommonFrontBackAPI.dll</HintPath>
</Reference>
<Reference Include="R_BlazorFrontEnd">
  <HintPath>..\..\..\..\SYSTEM\SOURCE\LIBRARY\Front\R_BlazorFrontEnd.dll</HintPath>
</Reference>
<Reference Include="R_ContextFrontEnd">
  <HintPath>..\..\..\..\SYSTEM\SOURCE\LIBRARY\Front\R_ContextFrontEnd.dll</HintPath>
</Reference>
```
**⚠️ CRITICAL**: Missing `R_ContextFrontEnd` will cause CS0246 build errors when using streaming context

## Required Using Statements - Complete List
```csharp
using R_BlazorFrontEnd;                    // For R_ViewModel<T>
using R_BlazorFrontEnd.Exceptions;         // For R_Exception
using R_BlazorFrontEnd.Helpers;            // For R_FrontUtility (CRITICAL - will fail build if missing)
using R_CommonFrontBackAPI;
using R_ContextFrontEnd;                   // For R_FrontContext.R_SetStreamingContext() (if using streaming context)
using {ProgramName}Common;
using {ProgramName}Common.DTOs;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Threading.Tasks;
```
**⚠️ CRITICAL**: Missing `using R_BlazorFrontEnd.Helpers;` will cause CS0103 error for R_FrontUtility

## ViewModel Inheritance Pattern - CRITICAL
```csharp
// ✅ CORRECT - All ViewModels MUST inherit from R_ViewModel<T>
public class FAM00100ViewModel : R_ViewModel<FAM00100DTO>
{
    private readonly FAM00100Model _model = new FAM00100Model();
    // Data property is inherited from R_ViewModel<T> - DO NOT declare manually
    // Other properties and methods...
}
```

## CRUD Operations Pattern - MANDATORY
```csharp
// ✅ CORRECT - CRUD methods for ViewModels with grids/conductors
public async Task GetRecordAsync(FAM00100DTO poEntity)
{
    var loEx = new R_Exception();
    try
    {
        var loResult = await _model.R_ServiceGetRecordAsync(poEntity);
        CurrentRecord = loResult; // Store in separate property, NOT Data
    }
    catch (Exception ex) { loEx.Add(ex); }
    loEx.ThrowExceptionIfErrors();
}

public async Task SaveRecordAsync(FAM00100DTO poEntity, eCRUDMode peCRUDMode)
{
    var loEx = new R_Exception();
    try
    {
        var loResult = await _model.R_ServiceSaveAsync(poEntity, peCRUDMode);
        CurrentRecord = loResult; // Store in separate property, NOT Data
    }
    catch (Exception ex) { loEx.Add(ex); }
    loEx.ThrowExceptionIfErrors();
}

public async Task DeleteRecordAsync(FAM00100DTO poEntity)
{
    var loEx = new R_Exception();
    try
    {
        await _model.R_ServiceDeleteAsync(poEntity);
    }
    catch (Exception ex) { loEx.Add(ex); }
    loEx.ThrowExceptionIfErrors();
}
```

## Data Property Usage - CRITICAL
```csharp
// ✅ CORRECT - Data property is READ-ONLY, use separate properties
public class FAM00100ViewModel : R_ViewModel<FAM00100DTO>
{
    // Data property is inherited and READ-ONLY - DO NOT assign to it
    public FAM00100DTO CurrentRecord { get; set; } = new FAM00100DTO(); // ✅ Use this instead
}

// ❌ WRONG - Cannot assign to Data property
Data = loResult; // CS0200: Property cannot be assigned to
```

## Grid Data Binding Pattern
**CRITICAL:** Grid data must flow through ViewModel properties, not return values

### Correct Data Flow
1. **Grid requests data** → `R_ServiceGetListRecord` is called
2. **ViewModel populates property** → `GetListAsync()` fills `DataList` property
3. **Grid receives data** → `eventArgs.ListEntityResult = _viewModel.DataList`

```csharp
// ✅ CORRECT - Populate ViewModel property
public async Task GetListAsync(FilterRequest poRequest)
{
    var loResult = await _model.GetListAsync(poRequest);
    if (loResult.Data != null)
    {
        DataList.Clear();
        DataList = new ObservableCollection<DTO>(loResult.Data);
    }
}

// ❌ WRONG - Returning data
public async Task<ObservableCollection<DTO>> GetListAsync(FilterRequest poRequest)
{
    var loResult = await _model.GetListAsync(poRequest);
    return new ObservableCollection<DTO>(loResult.Data);
}
```

### Grid Service Method
```csharp
public async Task R_ServiceGetListRecord(R_ServiceGetListRecordEventArgs eventArgs)
{
    var loRequest = new FilterRequest { /* parameters */ };
    await _viewModel.GetListAsync(loRequest); // Populates ViewModel property
    eventArgs.ListEntityResult = _viewModel.DataList; // Assign to grid
}
```

### Violations
- ❌ Returning collections instead of populating properties


## Frontend Global Variable Pattern (CRITICAL)
**RULE**: Never use `R_FrontGlobalVar` in ViewModels. Use `IClientHelper` injection in .razor.cs and pass values as parameters.

### ❌ Wrong Pattern - Using R_FrontGlobalVar in ViewModel
```csharp
// WRONG - Don't use R_FrontGlobalVar in ViewModel
public async Task GetRateTypeListAsync()
{
    var request = new SAM00110GetListRequest
    {
        CCOMPANY_ID = R_FrontGlobalVar.COMPANY_ID  // ❌ This class doesn't exist in .NET 6
    };
    // ...
}
```

## Viewmodel Pattern for Streaming Method
```csharp
public ObservableCollection<GetStreamingListResultDTO> StreamingList = new ObservableCollection<GetStreamingListResultDTO>();

public async Task GetStreamingListAsync(GetStreamingListParameterDTO poParameter)
{
    var loEx = new R_Exception();

    try
    {
        // Set streaming context for non-IClientHelper parameters
        R_FrontContext.R_SetStreamingContext("OTHER_PARAM_KEY", poParameter.OTHER_PARAM_KEY);

        var loResult = await _model.GetStreamingListAsync();

        StreamingList = new ObservableCollection<GetStreamingListResultDTO>(loResult.Data ?? new List<GetStreamingListResultDTO>());
    }
    catch (Exception ex)
    {
        loEx.Add(ex);
    }

    loEx.ThrowExceptionIfErrors();
}
```

## Error Message from Resources
**CRITICAL:** All error messages MUST come from resource files, never hardcoded

```csharp
var lcErrorMessage = R_FrontUtility.R_GetError(typeof(Resources_Dummy_Class), "ERR_INVALID_COMPANY_ID");
throw new R_Exception(lcErrorMessage);
```

## Data Validation Patterns - CRITICAL

### Validation Method Pattern
**RULE**: All validation logic MUST be in ViewModel, return `R_Exception`, and use resource-based error messages

#### ✅ CORRECT - Complete Validation Method
```csharp
/// <summary>
/// Validate tax category data
/// </summary>
/// <param name="poEntity">Tax category entity to validate</param>
/// <returns>R_Exception containing validation errors</returns>
public R_Exception ValidateTaxCategory(FAM00300DTO poEntity)
{
    var loEx = new R_Exception();

    // Validate Tax Category Code
    if (string.IsNullOrWhiteSpace(poEntity.CTAX_CATEGORY_CODE))
    {
        loEx.Add(R_FrontUtility.R_GetError(typeof(FAM00300FrontResources.Resources_Dummy_Class), "PS001"));
    }

    // Validate Tax Type
    if (string.IsNullOrWhiteSpace(poEntity.CTAX_TYPE))
    {
        loEx.Add(R_FrontUtility.R_GetError(typeof(FAM00300FrontResources.Resources_Dummy_Class), "PS002"));
    }

    // Validate Tax Category Description
    if (string.IsNullOrWhiteSpace(poEntity.CTAX_CATEGORY_DESC))
    {
        loEx.Add(R_FrontUtility.R_GetError(typeof(FAM00300FrontResources.Resources_Dummy_Class), "PS003"));
    }

    // Additional business rule validations
    if (!string.IsNullOrWhiteSpace(poEntity.CTAX_CATEGORY_CODE) && poEntity.CTAX_CATEGORY_CODE.Length > 8)
    {
        loEx.Add(R_FrontUtility.R_GetError(typeof(FAM00300FrontResources.Resources_Dummy_Class), "PS004"));
    }

    return loEx;
}
```

### Validation Error Handling Pattern
**RULE**: Always use `R_FrontUtility.R_GetError()` for resource-based error messages

```csharp
// ✅ CORRECT - Resource-based error messages using R_FrontUtility.R_GetError
loEx.Add(R_FrontUtility.R_GetError(typeof(FAM00300FrontResources.Resources_Dummy_Class), "PS001"));
loEx.Add(R_FrontUtility.R_GetError(typeof(FAM00300FrontResources.Resources_Dummy_Class), "ERR_INVALID_CODE"));

// ✅ CORRECT - Field-specific error messages
loEx.Add(R_FrontUtility.R_GetError(typeof(FAM00300FrontResources.Resources_Dummy_Class), "PS001")); // Field-specific validation

// ❌ WRONG - Hardcoded error messages
loEx.Add("", "Tax Category Code is required"); // Hardcoded string
loEx.Add("", "PS001"); // Resource key without R_FrontUtility.R_GetError
```

### Validation Method Naming Convention
- **Pattern**: `Validate{EntityName}({EntityDTO} poEntity)`
- **Examples**: 
  - `ValidateTaxCategory(FAM00300DTO poEntity)`
  - `ValidateCurrency(SAM00100DTO poEntity)`
  - `ValidateProduct(PRO00100DTO poEntity)`

## Streaming Context Pattern - CRITICAL

### When to Set Streaming Context
- **ONLY for streaming methods** (methods that return `IAsyncEnumerable` in Controller)
- **ONLY for custom parameters** (NOT for IClientHelper data like COMPANY_ID, USER_ID)
- **Set in ViewModel** before calling Model's streaming method

### How to Identify Custom Parameters
1. Check the Model's `*ParameterDTO` for the streaming method
2. If DTO has properties OTHER than `CCOMPANY_ID`, `CUSER_ID` → Those are custom parameters
3. **IClientHelper data** (COMPANY_ID, USER_ID) → Handled automatically by framework, NO streaming context needed

### Examples of Custom vs IClientHelper Parameters
**Custom Parameters (SET streaming context in ViewModel):**
- `ISTART_YEAR` - Start year for period
- `LFLAGPERIOD` - Period flag filter
- `LDEPT_MODE` - Department mode filter
- `CTRANSACTION_CODE` - Transaction code filter

**IClientHelper Parameters (DO NOT set streaming context):**
- `CCOMPANY_ID` - Set automatically in Controller
- `CUSER_ID` - Set automatically in Controller
- `CCULTURE` - Set automatically in Controller

### Pattern Examples
```csharp
S// ✅ CORRECT - Using specific ResultDTO
public ObservableCollection<FAM001000201GetDepartmentAssetCodeListResultDTO> DepartmentList { get; set; }
// Model returns: List<FAM001000201GetDepartmentAssetCodeListResultDTO>
```

### Using Resources in ViewModel Pattern
```csharp
// In validation methods
if (string.IsNullOrWhiteSpace(poEntity.CTRANS_DEPT_CODE))
{
    loEx.Add(R_FrontUtility.R_GetError(
        typeof({ProgramName}FrontResources.Resources_Dummy_Class),
        "ERR_TRANS_DEPT_REQUIRED"
    ));
}
```
